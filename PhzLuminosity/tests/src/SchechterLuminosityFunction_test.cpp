/*
 * SchechterLuminosityFunction_Test.cpp
 *
 *  Created on: Aug 3, 2015
 *      Author: fdubath
 */

#include <memory>
#include <vector>
#include <utility>
#include "ElementsKernel/Real.h"
#include "ElementsKernel/Exception.h"
#include <boost/test/unit_test.hpp>

#include "PhzLuminosity/SchechterLuminosityFunction.h"

using namespace Euclid;

struct SchechterLuminosityFunction_Fixture {
 std::vector<double> phi {0.01,0.5,1.,1.5};
 std::vector<double> mo {0.,0.5,1.,1.5};
 std::vector<double> lo {0.1,0.5,1.,1.5};
 std::vector<double> alpha {-1.5,-1.,-0.5};
 std::vector<double> m {0.,1.,10.};
 std::vector<double> l {0.1,1.,10.};


};


//-----------------------------------------------------------------------------

BOOST_AUTO_TEST_SUITE (SchechterLuminosityFunction_Test)

//---------------------------------------------------------------------------

BOOST_FIXTURE_TEST_CASE(test_functional_form_mag, SchechterLuminosityFunction_Fixture) {
  std::vector<std::vector<std::vector<std::vector<double>>>> result
  { //phi=0.01
    {
      {
        {
          0.00338829486904,
          0.00980347244867,
          0.920941938399
        },
        {
          0.00338829486904,
          0.0061855729429,
          0.00920941938399
        },
        {
          0.00338829486904,
          0.00390283267814,
          9.20941938399e-05
        }
      },
      {
        {
          0.00149956505782,
          0.00616956276777,
          0.731487398761
        },
        {
          0.00188784055793,
          0.00490065790234,
          0.00920888074707
        },
        {
          0.00237665045179,
          0.00389273094055,
          0.000115932939867
        }
      },
      {
        {
          0.00047138663352,
          0.00338829486904,
          0.580987234561
        },
        {
          0.000747097466483,
          0.00338829486904,
          0.00920802712962
        },
        {
          0.00118406968873,
          0.00338829486904,
          0.000145937395137
        }
      },
      {
        {
          8.61624830867e-05,
          0.00149956505782,
          0.461426767304
        },
        {
          0.000171916755467,
          0.00188784055793,
          0.0092066743992
        },
        {
          0.000343019023495,
          0.00237665045179,
          0.000183697304749
        }
      }
    },
    //phi=0.5
    {
      {
        {
          0.169414743452,
          0.490173622434,
          46.0470969199
        },
        {
          0.169414743452,
          0.309278647145,
          0.460470969199
        },
        {
          0.169414743452,
          0.195141633907,
          0.00460470969199
        }
      },
      {
        {
          0.074978252891,
          0.308478138388,
          36.574369938
        },
        {
          0.0943920278964,
          0.245032895117,
          0.460444037354
        },
        {
          0.11883252259,
          0.194636547028,
          0.00579664699333
        }
      },
      {
        {
          0.023569331676,
          0.169414743452,
          29.049361728
        },
        {
          0.0373548733241,
          0.169414743452,
          0.460401356481
        },
        {
          0.0592034844367,
          0.169414743452,
          0.00729686975686
        }
      },
      {
        {
          0.00430812415434,
          0.074978252891,
          23.0713383652
        },
        {
          0.00859583777336,
          0.0943920278964,
          0.46033371996
        },
        {
          0.0171509511748,
          0.11883252259,
          0.00918486523746
        }
      }
    },
    //phi=1.0
    {
      {
        {
          0.338829486904,
          0.980347244867,
          92.0941938399
        },
        {
          0.338829486904,
          0.61855729429,
          0.920941938399
        },
        {
          0.338829486904,
          0.390283267814,
          0.00920941938399
        }
      },
      {
        {
          0.149956505782,
          0.616956276777,
          73.1487398761
        },
        {
          0.188784055793,
          0.490065790234,
          0.920888074707
        },
        {
          0.237665045179,
          0.389273094055,
          0.0115932939867
        }
      },
      {
        {
          0.047138663352,
          0.338829486904,
          58.0987234561
        },
        {
          0.0747097466483,
          0.338829486904,
          0.920802712962
        },
        {
          0.118406968873,
          0.338829486904,
          0.0145937395137
        }
      },
      {
        {
          0.00861624830867,
          0.149956505782,
          46.1426767304
        },
        {
          0.0171916755467,
          0.188784055793,
          0.92066743992
        },
        {
          0.0343019023495,
          0.237665045179,
          0.0183697304749
        }
      }
    },
    //phi=1.5
    {
      {
        {
          0.508244230356,
          1.4705208673,
          100//138.14129076
        },
        {
          0.508244230356,
          0.927835941435,
          1.3814129076
        },
        {
          0.508244230356,
          0.585424901721,
          0.013814129076
        }
      },
      {
        {
          0.224934758673,
          0.925434415165,
          100//109.723109814
        },
        {
          0.283176083689,
          0.735098685351,
          1.38133211206
        },
        {
          0.356497567769,
          0.583909641083,
          0.01738994098
        }
      },
      {
        {
          0.070707995028,
          0.508244230356,
          87.1480851841
        },
        {
          0.112064619972,
          0.508244230356,
          1.38120406944
        },
        {
          0.17761045331,
          0.508244230356,
          0.0218906092706
        }
      },
      {
        {
          0.012924372463,
          0.224934758673,
          69.2140150957
        },
        {
          0.0257875133201,
          0.283176083689,
          1.38100115988
        },
        {
          0.0514528535243,
          0.356497567769,
          0.0275545957124
        }
      }
    }

  };





  for (size_t i = 0; i < phi.size(); ++i) {
    for (size_t j = 0; j < mo.size(); ++j) {
      for (size_t k = 0; k < alpha.size(); ++k) {
        for (size_t h = 0; h < m.size(); ++h) {



          auto function = Euclid::PhzLuminosity::SchechterLuminosityFunction {
              phi[i], mo[j], alpha[k], true };

          auto computed = function(m[h]);
          auto expected = result[i][j][k][h];


          auto error = std::abs(expected-computed)/expected;

          BOOST_CHECK(error < 1e-10);


        }
      }
    }
  }
}


BOOST_FIXTURE_TEST_CASE(test_functional_form_flux, SchechterLuminosityFunction_Fixture) {
  std::vector<std::vector<std::vector<std::vector<double>>>> result
  {
  //phi=0.01
    {
      {
        {
          0.0367879441171,
          1.43567183661e-07,
          3.72007597602e-48,
        },
        {
          0.0367879441171,
          4.53999297625e-07,
          3.72007597602e-47,
        },
        {
          0.0367879441171,
          1.43567183661e-06,
          3.72007597602e-46,
        },
      },
      {
        {
          0.183073761915,
          0.000956964965104,
          4.60887961184e-13,
        },
        {
          0.0818730753078,
          0.00135335283237,
          2.06115362244e-12,
        },
        {
          0.036614752383,
          0.00191392993021,
          9.21775922369e-12,
        },
      },
      {
        {
          0.286134715314,
          0.00367879441171,
          1.43567183661e-08,
        },
        {
          0.0904837418036,
          0.00367879441171,
          4.53999297625e-08,
        },
        {
          0.0286134715314,
          0.00367879441171,
          1.43567183661e-07,
        },
      },
      {
        {
          0.362320297329,
          0.0062880498342,
          4.92888951841e-07,
        },
        {
          0.0935506985032,
          0.00513417119033,
          1.27263380134e-06,
        },
        {
          0.0241546864886,
          0.0041920332228,
          3.28592634561e-06,
        },
      },
    },
    //phi=0.5
    {
      {
        {
          1.83939720586,
          7.17835918306e-06,
          1.86003798801e-46,
        },
        {
          1.83939720586,
          2.26999648812e-05,
          1.86003798801e-45,
        },
        {
          1.83939720586,
          7.17835918306e-05,
          1.86003798801e-44,
        },
      },
      {
        {
          9.15368809576,
          0.0478482482552,
          2.30443980592e-11,
        },
        {
          4.09365376539,
          0.0676676416183,
          1.03057681122e-10,
        },
        {
          1.83073761915,
          0.0956964965104,
          4.60887961184e-10,
        },
      },
      {
        {
          14.3067357657,
          0.183939720586,
          7.17835918306e-07,
        },
        {
          4.52418709018,
          0.183939720586,
          2.26999648812e-06,
        },
        {
          1.43067357657,
          0.183939720586,
          7.17835918306e-06,
        },
      },
      {
        {
          18.1160148664,
          0.31440249171,
          2.4644447592e-05,
        },
        {
          4.67753492516,
          0.256708559516,
          6.3631690067e-05,
        },
        {
          1.20773432443,
          0.20960166114,
          0.00016429631728,
        },
      },
    },
    //phi=1.0
    {
      {
        {
          3.67879441171,
          1.43567183661e-05,
          3.72007597602e-46,
        },
        {
          3.67879441171,
          4.53999297625e-05,
          3.72007597602e-45,
        },
        {
          3.67879441171,
          0.000143567183661,
          3.72007597602e-44,
        },
      },
      {
        {
          18.3073761915,
          0.0956964965104,
          4.60887961184e-11,
        },
        {
          8.18730753078,
          0.135335283237,
          2.06115362244e-10,
        },
        {
          3.6614752383,
          0.191392993021,
          9.21775922369e-10,
        },
      },
      {
        {
          28.6134715314,
          0.367879441171,
          1.43567183661e-06,
        },
        {
          9.04837418036,
          0.367879441171,
          4.53999297625e-06,
        },
        {
          2.86134715314,
          0.367879441171,
          1.43567183661e-05,
        },
      },
      {
        {
          36.2320297329,
          0.62880498342,
          4.92888951841e-05,
        },
        {
          9.35506985032,
          0.513417119033,
          0.000127263380134,
        },
        {
          2.41546864886,
          0.41920332228,
          0.000328592634561,
        },
      },
    },
    //phi=1.5
    {
      {
        {
          5.51819161757,
          2.15350775492e-05,
          5.58011396403e-46,
        },
        {
          5.51819161757,
          6.80998946437e-05,
          5.58011396403e-45,
        },
        {
          5.51819161757,
          0.000215350775492,
          5.58011396403e-44,
        },
      },
      {
        {
          27.4610642873,
          0.143544744766,
          6.91331941776e-11,
        },
        {
          12.2809612962,
          0.203002924855,
          3.09173043366e-10,
        },
        {
          5.49221285746,
          0.287089489531,
          1.38266388355e-09,
        },
      },
      {
        {
          42.9202072971,
          0.551819161757,
          2.15350775492e-06,
        },
        {
          13.5725612705,
          0.551819161757,
          6.80998946437e-06,
        },
        {
          4.29202072971,
          0.551819161757,
          2.15350775492e-05,
        },
      },
      {
        {
          54.3480445993,
          0.94320747513,
          7.39333427761e-05,
        },
        {
          14.0326047755,
          0.770125678549,
          0.000190895070201,
        },
        {
          3.62320297329,
          0.62880498342,
          0.000492888951841,
        },
      },
    },
 };


  for (size_t i = 0; i < phi.size(); ++i) {
     for (size_t j = 0; j < lo.size(); ++j) {
       for (size_t k = 0; k < alpha.size(); ++k) {
         for (size_t h = 0; h < l.size(); ++h) {



           auto function = Euclid::PhzLuminosity::SchechterLuminosityFunction {
               phi[i], lo[j], alpha[k], false };

           auto computed = function(l[h]);
           auto expected = result[i][j][k][h];


           auto error = std::abs(expected-computed)/expected;


           BOOST_CHECK(error < 1e-10);


         }
       }
     }
   }

}

//-----------------------------------------------------------------------------

BOOST_FIXTURE_TEST_CASE (test_functional_integrate_flux, SchechterLuminosityFunction_Fixture) {
  std::vector<std::vector<std::vector<std::vector<double>>>> result {
    //phi=0.01
    {
      {
        {
          0.00178146450877 ,
          1.26090426612e-08 ,
        },
        {
          0.00219379777427 ,
          4.15696893601e-08 ,
        },
        {
          0.00278791859014 ,
          1.37262662354e-07 ,
        },
      },
      {
        {
          0.01762893715 ,
          0.000300987570787 ,
        },
        {
          0.0117375003348 ,
          0.000489005106097 ,
        },
        {
          0.00853594265142 ,
          0.000806471175102 ,
        },
      },
      {
        {
          0.0322362162491 ,
          0.00178146450877 ,
        },
        {
          0.0160354002402 ,
          0.00219379777427 ,
        },
        {
          0.00881656899513 ,
          0.00278791859014 ,
        },
      },
      {
        {
          0.0433407710753 ,
          0.00377655996018 ,
        },
        {
          0.01797997356 ,
          0.00398240636448 ,
        },
        {
          0.00827359436101 ,
          0.00439484096459 ,
        },
      },
    },
//phi=0.50
    {
      {
        {
          0.0890732254386 ,
          6.30452130662e-07 ,
        },
        {
          0.109689888713 ,
          2.07848446484e-06 ,
        },
        {
          0.139395929507 ,
          6.8631331177e-06 ,
        },
      },
      {
        {
          0.8814468575 ,
          0.0150493785393 ,
        },
        {
          0.586875016738 ,
          0.0244502553049 ,
        },
        {
          0.426797132571 ,
          0.0403235587551 ,
        },
      },
      {
        {
          1.61181081246 ,
          0.0890732254386 ,
        },
        {
          0.801770012012 ,
          0.109689888713 ,
        },
        {
          0.440828449757 ,
          0.139395929507 ,
        },
      },
      {
        {
          2.16703855377 ,
          0.188827998009 ,
        },
        {
          0.898998678002 ,
          0.199120318224 ,
        },
        {
          0.413679718051 ,
          0.21974204823 ,
        },
      },
    },
//phi=1.00
    {
      {
        {
          0.178146450877 ,
          1.26090426132e-06 ,
        },
        {
          0.219379777427 ,
          4.15696892969e-06 ,
        },
        {
          0.278791859014 ,
          1.37262662354e-05 ,
        },
      },
      {
        {
          1.762893715 ,
          0.0300987570787 ,
        },
        {
          1.17375003348 ,
          0.0489005106097 ,
        },
        {
          0.853594265142 ,
          0.0806471175102 ,
        },
      },
      {
        {
          3.22362162491 ,
          0.178146450877 ,
        },
        {
          1.60354002402 ,
          0.219379777427 ,
        },
        {
          0.881656899513 ,
          0.278791859014 ,
        },
      },
      {
        {
          4.33407710753 ,
          0.377655996018 ,
        },
        {
          1.797997356 ,
          0.398240636448 ,
        },
        {
          0.827359436101 ,
          0.439484096459 ,
        },
      },
    },
//phi=1.50
    {
      {
        {
          0.267219676316 ,
          1.89135639199e-06 ,
        },
        {
          0.32906966614 ,
          6.23545339453e-06 ,
        },
        {
          0.418187788522 ,
          2.05893993531e-05 ,
        },
      },
      {
        {
          2.6443405725 ,
          0.045148135618 ,
        },
        {
          1.76062505021 ,
          0.0733507659146 ,
        },
        {
          1.28039139771 ,
          0.120970676265 ,
        },
      },
      {
        {
          4.83543243737 ,
          0.267219676316 ,
        },
        {
          2.40531003604 ,
          0.32906966614 ,
        },
        {
          1.32248534927 ,
          0.418187788522 ,
        },
      },
      {
        {
          6.5011156613 ,
          0.566483994027 ,
        },
        {
          2.69699603401 ,
          0.597360954671 ,
        },
        {
          1.24103915415 ,
          0.659226144689 ,
        },
      },
    }
  };

  for (size_t i = 0; i < phi.size(); ++i) {
    for (size_t j = 0; j < lo.size(); ++j) {
      for (size_t k = 0; k < alpha.size(); ++k) {
        for (size_t h = 0; h < l.size() - 1; ++h) {

          auto function = Euclid::PhzLuminosity::SchechterLuminosityFunction {
              phi[i], lo[j], alpha[k], false };

          auto computed = function.integrate(l[h], l[h + 1]);
          auto expected = result[i][j][k][h];


          BOOST_CHECK_CLOSE(computed, expected, 1e-6);
        }
      }
    }
  }
}

//-----------------------------------------------------------------------------

BOOST_FIXTURE_TEST_CASE (test_functional_integrate_mag, SchechterLuminosityFunction_Fixture) {
  std::vector<std::vector<std::vector<std::vector<double>>>> result {
//phi=0.01
    {
      {
        {
          0.00631136672172 ,
          1.95665807581 ,
        },
        {
          0.0048617873055 ,
          0.0792766203963 ,
        },
        {
          -0.011126975459 ,
          0.0109269821254 ,
        },
      },
      {
        {
          0.00353743337407 ,
          1.5493245886 ,
        },
        {
          0.00338950805395 ,
          0.0774557715545 ,
        },
        {
          -0.0130933119734 ,
          0.0128415401922 ,
        },
      },
      {
        {
          0.00164415897194 ,
          1.22500110019 ,
        },
        {
          0.0019485606768 ,
          0.0749295790835 ,
        },
        {
          -0.0149364826562 ,
          0.0146195305562 ,
        },
      },
      {
        {
          0.000579374836547 ,
          0.96672726734 ,
        },
        {
          0.000843711535071 ,
          0.0716373350816 ,
        },
        {
          -0.0163949808762 ,
          0.0159959813621 ,
        },
      },
    },
//phi=0.50
    {
      {
        {
          0.315568336086 ,
          97.8329037905 ,
        },
        {
          0.243089365275 ,
          3.96383101981 ,
        },
        {
          -0.556348772948 ,
          0.546349106271 ,
        },
      },
      {
        {
          0.176871668704 ,
          77.4662294302 ,
        },
        {
          0.169475402698 ,
          3.87278857773 ,
        },
        {
          -0.654665598671 ,
          0.642077009609 ,
        },
      },
      {
        {
          0.0822079485972 ,
          61.2500550097 ,
        },
        {
          0.09742803384 ,
          3.74647895418 ,
        },
        {
          -0.746824132812 ,
          0.730976527812 ,
        },
      },
      {
        {
          0.0289687418274 ,
          48.336363367 ,
        },
        {
          0.0421855767536 ,
          3.58186675408 ,
        },
        {
          -0.81974904381 ,
          0.799799068105 ,
        },
      },
    },
//phi=1.00
    {
      {
        {
          0.631136672172 ,
          195.665807581 ,
        },
        {
          0.48617873055 ,
          7.92766203963 ,
        },
        {
          -1.1126975459 ,
          1.09269821254 ,
        },
      },
      {
        {
          0.353743337407 ,
          154.93245886 ,
        },
        {
          0.338950805395 ,
          7.74557715545 ,
        },
        {
          -1.30933119734 ,
          1.28415401922 ,
        },
      },
      {
        {
          0.164415897194 ,
          122.500110019 ,
        },
        {
          0.19485606768 ,
          7.49295790835 ,
        },
        {
          -1.49364826562 ,
          1.46195305562 ,
        },
      },
      {
        {
          0.0579374836547 ,
          96.672726734 ,
        },
        {
          0.0843711535071 ,
          7.16373350816 ,
        },
        {
          -1.63949808762 ,
          1.59959813621 ,
        },
      },
    },
//phi=1.50
    {
      {
        {
          0.946705008259 ,
          280.8408636, //293.498711371 ,
        },
        {
          0.729268095825 ,
          11.8914930594 ,
        },
        {
          -1.66904631884 ,
          1.63904731881 ,
        },
      },
      {
        {
          0.530615006111 ,
          231.43460285, //232.398688291 ,
        },
        {
          0.508426208093 ,
          11.6183657332 ,
        },
        {
          -1.96399679601 ,
          1.92623102883 ,
        },
      },
      {
        {
          0.246623845792 ,
          183.750165029 ,
        },
        {
          0.29228410152 ,
          11.2394368625 ,
        },
        {
          -2.24047239844 ,
          2.19292958344 ,
        },
      },
      {
        {
          0.0869062254821 ,
          145.009090101 ,
        },
        {
          0.126556730261 ,
          10.7456002622 ,
        },
        {
          -2.45924713143 ,
          2.39939720432 ,
        },
      },
    }
  };

  for (size_t i = 0; i < phi.size(); ++i) {
    for (size_t j = 0; j < mo.size(); ++j) {
      for (size_t k = 0; k < alpha.size(); ++k) {
        for (size_t h = 0; h < m.size() - 1; ++h) {

          auto function = Euclid::PhzLuminosity::SchechterLuminosityFunction {
            phi[i], mo[j], alpha[k], true};

          auto computed = function.integrate(m[h], m[h + 1]);

          auto expected = result[i][j][k][h];


          BOOST_CHECK_CLOSE(computed, expected, 1e-6);
        }
      }
    }
  }
}

//-----------------------------------------------------------------------------

BOOST_AUTO_TEST_SUITE_END ()


